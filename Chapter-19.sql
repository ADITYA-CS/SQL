/**
 * @Author: ADITYA KUMAR SINGH <the__martian>
 * @Email:  cr7.aditya.cs@gmail.com
 * @Filename: Chapter-19.sql
 */

-----------------------------------------------------------------
              I N T E R N A L  P R O B L E M S
-----------------------------------------------------------------
use SchoolSchedulingExample;
-----------------------------------------------------------------
/*
“Prepare a list of IDs, student names, and the gender of the
student spelled out.”
*/
select
    S.StudentID,
    concat(S.StudFirstName, ' ', S.StudLastName) Name,
    case S.StudGender
        when 'M'
            then "Male"
        when 'F'
            then "Female"
        else
            "Unspecified"
    end as Gender
from
    Students S;
-----------------------------------------------------------------
/*
“Modify the students table by setting the grade point average to
the sum of the credits times the grade divided by the sum of the
credits.”
*/
update Students
set
    S.StudGPA = (
        select
            round(sum(C.Credits * SS.Grade)/sum(C.Credits), 3)
        from
            Classes C
        inner join
            Student_Schedules SS
            on C.ClassID = SS.ClassID
        where
            SS.ClassStatus = 2
            and
            SS.StudentID = S.StudentID
    );
-----------------------------------------------------------------
/*
“Display for all students the Student ID, first name, last name,
the number of classes completed, the total credits, and the grade
point average for classes that were completed with a grade of 67
or better.”
*/
select
    S.StudentID,
    S.StudFirstName,
    S.StudLastName,
    count(SClasses.StudentID) as NumberOfClasses,
    sum(SClasses.credits) as TotalCredits,
    case count(SClasses.StudentID)
        when 0
            then 0
        else
            round(sum(SClasses.Credits * SClasses.Grade) /
            sum(SClasses.Grade), 3)
    end as GPA
from
    Students S
inner join
    (
        select
            SS.StudentID,
            SS.Grade,
            C.Credits
        from
            Student_Schedules SS
        inner join
            Classes C
            on C.ClassID = SS.ClassID
        inner join
            Student_Class_Status SCS
            on SCS.ClassStatus = SS.ClassStatus
        where
            SCS.ClassStatusDescription = 'Completed'
            and
            SS.Grade >= 65
    ) as SClasses
    on S.StudentID = SClasses.StudentID
group by
    S.StudentID,
    S.StudFirstName,
    S.StudLastName;
-----------------------------------------------------------------
/*
“For all staff members, list staff ID, first name, last name,
date hired, and length of service in complete years as of October
1, 2017, sorted by last name and first name.”
*/
select
    S.StaffID,
    S.StfFirstName,
    S.StfLastname,
    year(cast('2017-10-01' as date)) - year(S.DateHired) -
        - case
            when month(S.DateHired) < 10
                then 0
            when month(S.DateHired) > 10
                then 1
            when day(S.DateHired) > 1
                then 1
            else
                0
        end as LenghtOfService
from
    Staff S
order by
    S.StaffID,
    S.StfFirstName,
    S.StfLastname;

-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
-----------------------------------------------------------------
